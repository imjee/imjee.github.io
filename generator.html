<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Poster (Puter.js Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://js.puter.com/v2/"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #a855f7; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6">

    <canvas id="posterCanvas" width="800" height="800" class="hidden"></canvas>

    <div class="max-w-7xl mx-auto">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-2">
                Poster Generator <span class="text-white text-2xl font-normal">by Puter.js</span>
            </h1>
            <p class="text-gray-400">Gratis Tanpa API Key Pribadi! (Login Puter Sekali Saja)</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-5 space-y-6">
                
                <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700">
                    <label class="block text-sm font-medium text-gray-300 mb-3">1. Upload Foto Produk</label>
                    <input type="file" id="imageInput" accept="image/*" class="hidden">
                    <div onclick="document.getElementById('imageInput').click()" class="border-2 border-dashed border-gray-600 rounded-xl h-48 flex flex-col items-center justify-center bg-gray-700/50 cursor-pointer hover:border-purple-500 transition overflow-hidden relative">
                        <img id="previewImage" src="" class="hidden h-full object-contain z-10">
                        <div id="uploadPlaceholder" class="text-center">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-400">Klik Upload Foto</p>
                        </div>
                    </div>
                </div>

                <button id="askAiBtn" class="w-full py-3 bg-purple-700 hover:bg-purple-600 border border-purple-500 rounded-xl font-semibold text-white transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-brain"></i> Minta AI Tulis Caption
                </button>

                <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700">
                    <label class="block text-sm font-medium text-gray-300 mb-3">3. Hasil Teks (Edit Disini)</label>
                    <textarea id="textInput" class="w-full h-32 bg-gray-700/50 border border-gray-600 rounded-xl p-4 text-gray-200 focus:ring-2 focus:ring-purple-500 focus:outline-none resize-none" placeholder="Upload foto & klik tombol AI di atas..."></textarea>
                </div>

                <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700">
                    <label class="block text-sm font-medium text-gray-300 mb-3">4. Gaya Background</label>
                    <select id="backgroundStyle" class="w-full bg-gray-700/50 border border-gray-600 rounded-xl p-3 text-gray-200 focus:ring-2 focus:ring-purple-500 focus:outline-none">
                        <option value="gemini-suggested">Rekomendasi AI</option>
                        <option value="abstract-gradient-purple">Gradien Ungu</option>
                        <option value="geometric-blue">Geometris Biru</option>
                        <option value="minimal-soft-yellow">Kuning Minimalis</option>
                        <option value="dark-modern">Dark Modern</option>
                    </select>
                </div>

                <button id="generateBtn" class="w-full py-4 bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500 rounded-xl font-bold text-lg shadow-lg hover:shadow-purple-500/50 hover:scale-[1.02] transition transform">
                    <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Buat Poster
                </button>
            </div>

            <div class="lg:col-span-7 bg-gray-800/50 p-6 rounded-3xl border border-gray-700 flex flex-col items-center justify-center min-h-[500px]">
                <img id="finalResult" src="https://via.placeholder.com/800x800?text=Preview+Poster" class="max-h-[600px] w-full object-contain rounded shadow-2xl border border-gray-800">
                <a id="downloadLink" href="#" download="poster-ai.png" class="mt-4 bg-white text-black px-6 py-2 rounded-full font-bold shadow-lg hover:bg-gray-200 hidden transition">
                    <i class="fas fa-download mr-2"></i> Download
                </a>
            </div>
        </div>
    </div>

    <script>
        let uploadedImageFile = null;   // File asli untuk diupload ke Puter
        let uploadedImageElement = null; // Gambar untuk digambar di Canvas
        let aiSuggestedStyle = "abstract-gradient-purple"; 

        const imageInput = document.getElementById('imageInput');
        const previewImage = document.getElementById('previewImage');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const askAiBtn = document.getElementById('askAiBtn');
        const textInput = document.getElementById('textInput');
        const backgroundStyleSelect = document.getElementById('backgroundStyle');
        const generateBtn = document.getElementById('generateBtn');
        const finalResult = document.getElementById('finalResult');
        const downloadLink = document.getElementById('downloadLink');

        // --- Draw Functions (Sama seperti sebelumnya) ---
        const drawBackground = {
            'abstract-gradient-purple': (ctx) => {
                const gradient = ctx.createLinearGradient(0, 0, 800, 800);
                gradient.addColorStop(0, '#4c1d95'); gradient.addColorStop(1, '#db2777');
                ctx.fillStyle = gradient; ctx.fillRect(0, 0, 800, 800);
                ctx.fillStyle = 'rgba(255,255,255,0.05)';
                ctx.beginPath(); ctx.arc(700, 100, 200, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(100, 700, 250, 0, Math.PI*2); ctx.fill();
            },
            'geometric-blue': (ctx) => {
                ctx.fillStyle = '#0f172a'; ctx.fillRect(0, 0, 800, 800);
                ctx.strokeStyle = 'rgba(59, 130, 246, 0.3)'; ctx.lineWidth = 2;
                for (let i = 0; i < 20; i++) {
                    ctx.beginPath(); ctx.moveTo(0, i * 40); ctx.lineTo(800, (i * 40) - 200); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(i * 40, 0); ctx.lineTo((i * 40) - 200, 800); ctx.stroke();
                }
            },
            'minimal-soft-yellow': (ctx) => {
                ctx.fillStyle = '#fffbeb'; ctx.fillRect(0, 0, 800, 800);
                ctx.fillStyle = 'rgba(252, 211, 77, 0.3)';
                ctx.beginPath(); ctx.arc(650, 150, 180, 0, Math.PI*2); ctx.fill();
            },
            'dark-modern': (ctx) => {
                const gradient = ctx.createRadialGradient(400, 400, 0, 400, 400, 800);
                gradient.addColorStop(0, '#111827'); gradient.addColorStop(1, '#0f172a');
                ctx.fillStyle = gradient; ctx.fillRect(0, 0, 800, 800);
            }
        };

        // 1. Handle Input Gambar
        imageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                uploadedImageFile = file; // Simpan file mentah untuk Puter
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    previewImage.classList.remove('hidden');
                    uploadPlaceholder.classList.add('hidden');
                    uploadedImageElement = new Image();
                    uploadedImageElement.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // 2. Logika Puter.js (Gantikan Gemini SDK)
        askAiBtn.addEventListener('click', async () => {
            if (!uploadedImageFile) {
                alert("Upload foto dulu!");
                return;
            }

            const originalText = askAiBtn.innerHTML;
            askAiBtn.innerHTML = `<div class="loader mr-2"></div> Upload & Analisa (Login jika diminta)...`;
            askAiBtn.disabled = true;

            try {
                // Langkah A: Upload gambar ke Cloud Puter sementara agar bisa dibaca AI
                // Nama file diacak agar unik
                const fileName = `temp_img_${Date.now()}.jpg`;
                const puterFile = await puter.write(fileName, uploadedImageFile);
                
                // Langkah B: Panggil Chat AI dengan gambar
                // Kita pakai 'gpt-4o-mini' atau 'gemini-flash' (Puter support multi model)
                const promptText = `
                    Lihat gambar produk ini. Bertindaklah sebagai copywriter ahli.
                    Berikan saya 3 baris teks untuk poster iklan (Bahasa Indonesia):
                    1. Headline (Singkat, Padat, Menarik, Kapital Semua)
                    2. Promo/Harga (Contoh: DISKON 50% atau HANYA 50RB)
                    3. Ajakan Bertindak (CTA)
                    4. BACKGROUND_STYLE: [pilih salah satu: abstract-gradient-purple, geometric-blue, minimal-soft-yellow, dark-modern]
                    
                    Hanya berikan output teks mentah baris per baris tanpa markdown.
                `;

                // Format pesan untuk Puter.js (Multimodal)
                const response = await puter.chat([
                    {
                        role: "user",
                        content: [
                            { type: "text", text: promptText },
                            { type: "image_url", image_url: { url: puterFile.readName } } // Atau pake url publik jika ada
                        ]
                    },
                    // Alternatif sintaks Puter v2 untuk file lokal yg sudah diupload:
                    // { type: "file", puter_path: puterFile.path }
                ], { model: 'gpt-4o-mini' }); // GPT-4o-mini sangat cepat & bagus untuk vision

                // Langkah C: Bersihkan output
                const fullText = response?.message?.content || response.toString(); // Handle variasi respon
                
                const lines = fullText.split('\n');
                let textContent = [];
                
                for (const line of lines) {
                    if (line.includes("BACKGROUND_STYLE:")) {
                        const styleValue = line.split(":")[1].trim();
                        if (drawBackground[styleValue]) aiSuggestedStyle = styleValue;
                    } else {
                        if(line.trim() !== "") textContent.push(line.replace(/\*/g, '').trim());
                    }
                }

                textInput.value = textContent.join('\n');
                backgroundStyleSelect.value = aiSuggestedStyle;

                // Hapus file temp di cloud agar bersih (opsional)
                // await puter.delete(fileName);

            } catch (error) {
                console.error(error);
                alert("Terjadi Error: " + error.message + "\n\nPastikan Anda sudah mengizinkan popup Login dari Puter.com!");
            } finally {
                askAiBtn.innerHTML = originalText;
                askAiBtn.disabled = false;
            }
        });

        // 3. Render Poster (Sama seperti sebelumnya)
        generateBtn.addEventListener('click', () => {
            if (!uploadedImageElement) { alert("Belum ada foto!"); return; }

            const canvas = document.getElementById('posterCanvas');
            const ctx = canvas.getContext('2d');
            const textLines = textInput.value.split('\n').filter(line => line.trim() !== '');
            
            let selectedStyle = backgroundStyleSelect.value;
            if (selectedStyle === "gemini-suggested") selectedStyle = aiSuggestedStyle;
            
            // Draw BG
            if (drawBackground[selectedStyle]) drawBackground[selectedStyle](ctx);
            else drawBackground['abstract-gradient-purple'](ctx);

            // Draw Image
            const scale = Math.min(450 / uploadedImageElement.width, 450 / uploadedImageElement.height);
            const w = uploadedImageElement.width * scale;
            const h = uploadedImageElement.height * scale;
            const x = (800 - w) / 2;
            const y = (800 - h) / 2;

            ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 30;
            ctx.drawImage(uploadedImageElement, x, y, w, h);
            ctx.shadowBlur = 0;

            // Draw Text
            ctx.textAlign = 'center';
            
            if (textLines[0]) {
                ctx.font = '900 60px Inter, sans-serif';
                ctx.fillStyle = 'white';
                ctx.shadowColor = "rgba(0,0,0,0.8)"; ctx.shadowBlur = 10;
                if(selectedStyle === 'minimal-soft-yellow') ctx.fillStyle = '#1e293b';
                ctx.fillText(textLines[0].toUpperCase(), 400, 120);
            }
            
            if (textLines[1]) {
                ctx.font = '800 50px Inter, sans-serif';
                ctx.fillStyle = '#facc15';
                if(selectedStyle === 'minimal-soft-yellow') ctx.fillStyle = '#b45309';
                ctx.shadowBlur = 0;
                ctx.fillText(textLines[1], 400, 650);
            }

            if (textLines[2]) {
                ctx.fillStyle = 'white';
                if(selectedStyle === 'minimal-soft-yellow') ctx.fillStyle = '#1e293b';
                roundRect(ctx, 250, 700, 300, 70, 35);
                ctx.fill();
                ctx.fillStyle = '#4c1d95';
                if(selectedStyle === 'minimal-soft-yellow') ctx.fillStyle = 'white';
                ctx.font = 'bold 30px Inter, sans-serif';
                ctx.fillText(textLines[2].toUpperCase(), 400, 745);
            }

            finalResult.src = canvas.toDataURL('image/png');
            downloadLink.href = canvas.toDataURL('image/png');
            downloadLink.classList.remove('hidden');
            downloadLink.classList.add('inline-flex');
        });

        function roundRect(ctx, x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            ctx.beginPath(); ctx.moveTo(x + r, y); ctx.arcTo(x + w, y, x + w, y + h, r);
            ctx.arcTo(x + w, y + h, x, y + h, r); ctx.arcTo(x, y + h, x, y, r);
            ctx.arcTo(x, y, x + w, y, r); ctx.closePath();
        }
    </script>
</body>
</html>