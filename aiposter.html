<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Poster Generator (Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #a855f7; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6">

    <canvas id="posterCanvas" width="800" height="800" class="hidden"></canvas>

    <div class="max-w-7xl mx-auto">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-green-500 mb-2">
                Poster Generator V2
            </h1>
            <p class="text-gray-400">Versi Perbaikan: Menggunakan Model Flash Terbaru</p>
        </div>

        <div class="max-w-2xl mx-auto mb-8">
            <div class="bg-gray-800 border border-green-500/50 p-4 rounded-xl flex gap-3 items-center shadow-[0_0_15px_rgba(34,197,94,0.2)]">
                <i class="fas fa-check-circle text-green-400"></i>
                <input type="password" id="apiKeyInput" value="AIzaSyBkX9ZxkCzE5SJBe_7KRIsFeiZnBkTLyaA" class="bg-transparent w-full text-sm focus:outline-none text-gray-400" readonly>
                <span class="text-xs text-green-400 font-bold whitespace-nowrap">Connected</span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-5 space-y-6">
                
                <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700">
                    <label class="block text-sm font-medium text-gray-300 mb-3">1. Upload Foto Produk</label>
                    <input type="file" id="imageInput" accept="image/*" class="hidden">
                    <div onclick="document.getElementById('imageInput').click()" class="border-2 border-dashed border-gray-600 rounded-xl h-48 flex flex-col items-center justify-center bg-gray-700/50 cursor-pointer hover:border-purple-500 transition overflow-hidden relative">
                        <img id="previewImage" src="" class="hidden h-full object-contain z-10">
                        <div id="uploadPlaceholder" class="text-center">
                            <i class="fas fa-camera text-3xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-400">Klik Upload Foto</p>
                        </div>
                    </div>
                </div>

                <button id="askGeminiBtn" class="w-full py-3 bg-gray-700 hover:bg-gray-600 border border-gray-600 rounded-xl font-semibold text-blue-300 transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-robot"></i> Minta Gemini Tulis Caption
                </button>

                <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 relative">
                    <label class="block text-sm font-medium text-gray-300 mb-3">3. Teks Poster (Edit jika perlu)</label>
                    <textarea id="textInput" class="w-full h-32 bg-gray-700/50 border border-gray-600 rounded-xl p-4 text-gray-200 focus:ring-2 focus:ring-purple-500 focus:outline-none resize-none" placeholder="Hasil dari Gemini akan muncul di sini..."></textarea>
                </div>

                 <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700">
                    <label class="block text-sm font-medium text-gray-300 mb-3">4. Gaya Background</label>
                    <select id="backgroundStyle" class="w-full bg-gray-700/50 border border-gray-600 rounded-xl p-3 text-gray-200 focus:ring-2 focus:ring-purple-500 focus:outline-none">
                        <option value="gemini-suggested">Rekomendasi Gemini</option>
                        <option value="abstract-gradient-purple">Gradien Abstrak (Ungu-Pink)</option>
                        <option value="geometric-blue">Pola Geometris (Biru)</option>
                        <option value="minimal-soft-yellow">Minimalis Lembut (Kuning)</option>
                        <option value="dynamic-lines-green">Garis Dinamis (Hijau)</option>
                        <option value="dark-modern">Dark Modern</option>
                    </select>
                </div>

                <button id="generateBtn" class="w-full py-4 bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500 rounded-xl font-bold text-lg shadow-lg hover:shadow-purple-500/50 hover:scale-[1.02] transition transform">
                    <i class="fa-solid fa-paint-brush mr-2"></i> Render Poster
                </button>
            </div>

            <div class="lg:col-span-7 bg-gray-800/50 p-6 rounded-3xl border border-gray-700 flex flex-col items-center justify-center min-h-[500px]">
                <img id="finalResult" src="https://via.placeholder.com/800x800?text=Preview+Poster" class="max-h-[600px] w-full object-contain rounded shadow-2xl border border-gray-800">
                <a id="downloadLink" href="#" download="poster-gemini.png" class="mt-4 bg-white text-black px-6 py-2 rounded-full font-bold shadow-lg hover:bg-gray-200 hidden transition">
                    <i class="fas fa-download mr-2"></i> Download Poster
                </a>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        let uploadedFileBase64 = null;
        let uploadedImageElement = null;
        let geminiSuggestedStyle = "abstract-gradient-purple"; 

        const imageInput = document.getElementById('imageInput');
        const previewImage = document.getElementById('previewImage');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const askGeminiBtn = document.getElementById('askGeminiBtn');
        const textInput = document.getElementById('textInput');
        const backgroundStyleSelect = document.getElementById('backgroundStyle');
        const generateBtn = document.getElementById('generateBtn');
        const finalResult = document.getElementById('finalResult');
        const downloadLink = document.getElementById('downloadLink');
        const apiKeyInput = document.getElementById('apiKeyInput');

        // --- Background Drawing Styles ---
        const drawBackground = {
            'abstract-gradient-purple': (ctx) => {
                const gradient = ctx.createLinearGradient(0, 0, 800, 800);
                gradient.addColorStop(0, '#4c1d95');
                gradient.addColorStop(1, '#db2777');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 800, 800);
                ctx.fillStyle = 'rgba(255,255,255,0.05)';
                ctx.beginPath(); ctx.arc(700, 100, 200, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(100, 700, 250, 0, Math.PI*2); ctx.fill();
            },
            'geometric-blue': (ctx) => {
                ctx.fillStyle = '#0f172a';
                ctx.fillRect(0, 0, 800, 800);
                ctx.strokeStyle = 'rgba(59, 130, 246, 0.3)';
                ctx.lineWidth = 2;
                for (let i = 0; i < 20; i++) {
                    ctx.beginPath(); ctx.moveTo(0, i * 40); ctx.lineTo(800, (i * 40) - 200); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(i * 40, 0); ctx.lineTo((i * 40) - 200, 800); ctx.stroke();
                }
            },
            'minimal-soft-yellow': (ctx) => {
                ctx.fillStyle = '#fffbeb';
                ctx.fillRect(0, 0, 800, 800);
                ctx.fillStyle = 'rgba(252, 211, 77, 0.3)';
                ctx.beginPath(); ctx.arc(650, 150, 180, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.rect(100, 600, 250, 150); ctx.fill();
            },
            'dynamic-lines-green': (ctx) => {
                ctx.fillStyle = '#064e3b';
                ctx.fillRect(0, 0, 800, 800);
                ctx.strokeStyle = 'rgba(110, 231, 183, 0.5)';
                ctx.lineWidth = 3;
                for (let i = 0; i < 50; i++) {
                    ctx.beginPath();
                    ctx.moveTo(Math.random() * 800, Math.random() * 800);
                    ctx.lineTo(Math.random() * 800, Math.random() * 800);
                    ctx.stroke();
                }
            },
            'dark-modern': (ctx) => {
                const gradient = ctx.createRadialGradient(400, 400, 0, 400, 400, 800);
                gradient.addColorStop(0, '#111827');
                gradient.addColorStop(1, '#0f172a');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 800, 800);
                ctx.strokeStyle = 'rgba(100, 100, 100, 0.2)';
                ctx.lineWidth = 1;
                for(let i=0; i < 10; i++) {
                    ctx.beginPath(); ctx.arc(400, 400, 100 + i * 50, 0, Math.PI * 2); ctx.stroke();
                }
            }
        };

        imageInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    previewImage.classList.remove('hidden');
                    uploadPlaceholder.classList.add('hidden');
                    uploadedFileBase64 = e.target.result.split(',')[1];
                    uploadedImageElement = new Image();
                    uploadedImageElement.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        askGeminiBtn.addEventListener('click', async () => {
            const apiKey = apiKeyInput.value.trim();
            if (!uploadedFileBase64) {
                alert("Upload foto produk dulu!");
                return;
            }

            const originalBtnText = askGeminiBtn.innerHTML;
            askGeminiBtn.innerHTML = `<div class="loader mr-2"></div> Gemini sedang berpikir...`;
            askGeminiBtn.disabled = true;

            try {
                const genAI = new GoogleGenerativeAI(apiKey);
                // PERBAIKAN DISINI: Menggunakan 'gemini-1.5-flash-latest'
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash-latest" });

                const prompt = `
                    Lihat gambar produk ini. 
                    Berikan rekomendasi 3 baris teks poster (hard selling, Bahasa Indonesia) DAN rekomendasi gaya background visual yang cocok.
                    Format output (tanpa markdown):
                    HEADLINE_TEKS
                    PROMO_TEKS
                    CALL_TO_ACTION_TEKS
                    BACKGROUND_STYLE: [pilih salah satu: abstract-gradient-purple, geometric-blue, minimal-soft-yellow, dynamic-lines-green, dark-modern]
                `;

                const imagePart = {
                    inlineData: { data: uploadedFileBase64, mimeType: "image/jpeg" },
                };

                const result = await model.generateContent([prompt, imagePart]);
                const response = await result.response;
                const fullText = response.text().trim();

                const lines = fullText.split('\n');
                let textContent = [];
                let backgroundStyle = "abstract-gradient-purple"; 

                for (const line of lines) {
                    if (line.includes("BACKGROUND_STYLE:")) {
                        const styleValue = line.split(":")[1].trim();
                        if (drawBackground[styleValue]) { 
                            backgroundStyle = styleValue;
                        }
                    } else {
                        if(line.trim() !== "") textContent.push(line.trim());
                    }
                }
                
                textInput.value = textContent.join('\n');
                geminiSuggestedStyle = backgroundStyle; 
                backgroundStyleSelect.value = geminiSuggestedStyle; 

            } catch (error) {
                console.error(error);
                alert("Error Gemini: " + error.message + "\n\nJika masih error, coba refresh halaman.");
            } finally {
                askGeminiBtn.innerHTML = originalBtnText;
                askGeminiBtn.disabled = false;
            }
        });

        generateBtn.addEventListener('click', () => {
            if (!uploadedImageElement) {
                alert("Upload foto dulu!");
                return;
            }

            const canvas = document.getElementById('posterCanvas');
            const ctx = canvas.getContext('2d');
            const textLines = textInput.value.split('\n').filter(line => line.trim() !== '');
            
            let selectedStyle = backgroundStyleSelect.value;
            if (selectedStyle === "gemini-suggested") {
                selectedStyle = geminiSuggestedStyle;
            }

            // Draw Background
            if (drawBackground[selectedStyle]) {
                drawBackground[selectedStyle](ctx);
            } else {
                drawBackground['abstract-gradient-purple'](ctx);
            }

            // Product Image
            const scale = Math.min(450 / uploadedImageElement.width, 450 / uploadedImageElement.height);
            const w = uploadedImageElement.width * scale;
            const h = uploadedImageElement.height * scale;
            const x = (800 - w) / 2;
            const y = (800 - h) / 2;

            ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 30;
            ctx.drawImage(uploadedImageElement, x, y, w, h);
            ctx.shadowBlur = 0;

            // Text Rendering
            ctx.textAlign = 'center';
            
            // Line 1
            if (textLines[0]) {
                ctx.font = '900 60px Inter, sans-serif';
                ctx.fillStyle = 'white';
                ctx.shadowColor = "rgba(0,0,0,0.8)"; ctx.shadowBlur = 10;
                if(selectedStyle === 'minimal-soft-yellow') ctx.fillStyle = '#1e293b';
                ctx.fillText(textLines[0].replace(/\*/g, '').toUpperCase(), 400, 120);
            }
            
            // Line 2
            if (textLines[1]) {
                ctx.font = '800 50px Inter, sans-serif';
                ctx.fillStyle = '#facc15'; 
                if(selectedStyle === 'minimal-soft-yellow') ctx.fillStyle = '#b45309';
                ctx.shadowBlur = 0;
                ctx.fillText(textLines[1].replace(/\*/g, ''), 400, 650);
            }

            // Line 3
            if (textLines[2]) {
                ctx.fillStyle = 'white';
                if(selectedStyle === 'minimal-soft-yellow') ctx.fillStyle = '#1e293b';
                roundRect(ctx, 250, 700, 300, 70, 35);
                ctx.fill();
                ctx.fillStyle = '#4c1d95';
                if(selectedStyle === 'minimal-soft-yellow') ctx.fillStyle = 'white';
                ctx.font = 'bold 30px Inter, sans-serif';
                ctx.fillText(textLines[2].replace(/\*/g, '').toUpperCase(), 400, 745);
            }

            finalResult.src = canvas.toDataURL('image/png');
            downloadLink.href = canvas.toDataURL('image/png');
            downloadLink.classList.remove('hidden');
            downloadLink.classList.add('inline-flex');
        });

        function roundRect(ctx, x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.arcTo(x + w, y, x + w, y + h, r);
            ctx.arcTo(x + w, y + h, x, y + h, r);
            ctx.arcTo(x, y + h, x, y, r);
            ctx.arcTo(x, y, x + w, y, r);
            ctx.closePath();
        }
    </script>
</body>
</html>