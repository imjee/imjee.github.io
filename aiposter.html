<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Poster Generator (Auto-Login)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #a855f7; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6">

    <canvas id="posterCanvas" width="800" height="800" class="hidden"></canvas>

    <div class="max-w-7xl mx-auto">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-2">
                Poster Generator + Gemini
            </h1>
            <p class="text-gray-400">API Key sudah terpasang. Silakan langsung upload foto!</p>
        </div>

        <div class="max-w-2xl mx-auto mb-8">
            <div class="bg-gray-800 border border-green-500/50 p-4 rounded-xl flex gap-3 items-center shadow-[0_0_15px_rgba(34,197,94,0.2)]">
                <i class="fas fa-check-circle text-green-400"></i>
                <input type="password" id="apiKeyInput" value="AIzaSyBkX9ZxkCzE5SJBe_7KRIsFeiZnBkTLyaA" class="bg-transparent w-full text-sm focus:outline-none text-gray-400" readonly>
                <span class="text-xs text-green-400 font-bold whitespace-nowrap">Terhubung</span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-5 space-y-6">
                
                <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700">
                    <label class="block text-sm font-medium text-gray-300 mb-3">1. Upload Foto Produk</label>
                    <input type="file" id="imageInput" accept="image/*" class="hidden">
                    <div onclick="document.getElementById('imageInput').click()" class="border-2 border-dashed border-gray-600 rounded-xl h-48 flex flex-col items-center justify-center bg-gray-700/50 cursor-pointer hover:border-purple-500 transition overflow-hidden relative">
                        <img id="previewImage" src="" class="hidden h-full object-contain z-10">
                        <div id="uploadPlaceholder" class="text-center">
                            <i class="fas fa-camera text-3xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-400">Klik Upload Foto</p>
                        </div>
                    </div>
                </div>

                <button id="askGeminiBtn" class="w-full py-3 bg-gray-700 hover:bg-gray-600 border border-gray-600 rounded-xl font-semibold text-blue-300 transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-robot"></i> Buatkan Caption Otomatis
                </button>

                <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 relative">
                    <label class="block text-sm font-medium text-gray-300 mb-3">3. Teks Poster</label>
                    <textarea id="textInput" class="w-full h-32 bg-gray-700/50 border border-gray-600 rounded-xl p-4 text-gray-200 focus:ring-2 focus:ring-purple-500 focus:outline-none resize-none" placeholder="Hasil dari Gemini akan muncul di sini..."></textarea>
                </div>

                <button id="generateBtn" class="w-full py-4 bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500 rounded-xl font-bold text-lg shadow-lg hover:shadow-purple-500/50 hover:scale-[1.02] transition transform">
                    <i class="fa-solid fa-paint-brush mr-2"></i> Render Poster
                </button>
            </div>

            <div class="lg:col-span-7 bg-gray-800/50 p-6 rounded-3xl border border-gray-700 flex flex-col items-center justify-center min-h-[500px]">
                <img id="finalResult" src="https://via.placeholder.com/800x800?text=Preview+Poster" class="max-h-[600px] w-full object-contain rounded shadow-2xl border border-gray-800">
                <a id="downloadLink" href="#" download="poster-gemini.png" class="mt-4 bg-white text-black px-6 py-2 rounded-full font-bold shadow-lg hover:bg-gray-200 hidden transition">
                    <i class="fas fa-download mr-2"></i> Download Poster
                </a>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        let uploadedFileBase64 = null;
        let uploadedImageElement = null;

        const imageInput = document.getElementById('imageInput');
        const previewImage = document.getElementById('previewImage');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const askGeminiBtn = document.getElementById('askGeminiBtn');
        const textInput = document.getElementById('textInput');
        const generateBtn = document.getElementById('generateBtn');
        const finalResult = document.getElementById('finalResult');
        const downloadLink = document.getElementById('downloadLink');
        const apiKeyInput = document.getElementById('apiKeyInput');

        imageInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    previewImage.classList.remove('hidden');
                    uploadPlaceholder.classList.add('hidden');
                    uploadedFileBase64 = e.target.result.split(',')[1];
                    uploadedImageElement = new Image();
                    uploadedImageElement.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        askGeminiBtn.addEventListener('click', async () => {
            const apiKey = apiKeyInput.value.trim(); // Mengambil key yang sudah di-hardcode
            if (!uploadedFileBase64) {
                alert("Upload foto produk dulu!");
                return;
            }

            const originalBtnText = askGeminiBtn.innerHTML;
            askGeminiBtn.innerHTML = `<div class="loader mr-2"></div> Sedang menganalisa foto...`;
            askGeminiBtn.disabled = true;

            try {
                const genAI = new GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

                const prompt = `
                    Lihat gambar produk ini. 
                    Buatkan 3 baris teks poster yang sangat menarik (Hard Selling) dalam Bahasa Indonesia:
                    Baris 1: Headline utama (maks 4 kata, kapital semua, meyakinkan).
                    Baris 2: Promo/Harga (contoh: "DISKON 50%" atau "HANYA 100RB").
                    Baris 3: Kata ajakan (contoh: "ORDER SEKARANG").
                    Hanya berikan teks mentahnya saja per baris.
                `;

                const imagePart = {
                    inlineData: { data: uploadedFileBase64, mimeType: "image/jpeg" },
                };

                const result = await model.generateContent([prompt, imagePart]);
                const response = await result.response;
                textInput.value = response.text().trim();

            } catch (error) {
                console.error(error);
                alert("Error: " + error.message + "\nCek kuota API Key atau koneksi internet.");
            } finally {
                askGeminiBtn.innerHTML = originalBtnText;
                askGeminiBtn.disabled = false;
            }
        });

        generateBtn.addEventListener('click', () => {
            if (!uploadedImageElement) {
                alert("Upload foto dulu!");
                return;
            }

            const canvas = document.getElementById('posterCanvas');
            const ctx = canvas.getContext('2d');
            const textLines = textInput.value.split('\n').filter(line => line.trim() !== '');

            // Background
            const gradient = ctx.createLinearGradient(0, 0, 800, 800);
            gradient.addColorStop(0, '#1e1b4b'); 
            gradient.addColorStop(1, '#4c1d95'); 
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 800, 800);

            // Decoration Circles
            ctx.fillStyle = '#fbbf24'; 
            ctx.globalAlpha = 0.1;
            ctx.beginPath(); ctx.arc(750, 50, 300, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#db2777'; 
            ctx.beginPath(); ctx.arc(50, 750, 350, 0, Math.PI*2); ctx.fill();
            ctx.globalAlpha = 1.0;

            // Product Image
            const scale = Math.min(450 / uploadedImageElement.width, 450 / uploadedImageElement.height);
            const w = uploadedImageElement.width * scale;
            const h = uploadedImageElement.height * scale;
            const x = (800 - w) / 2;
            const y = (800 - h) / 2;

            ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 30;
            ctx.drawImage(uploadedImageElement, x, y, w, h);
            ctx.shadowBlur = 0;

            // Text Rendering
            ctx.textAlign = 'center';
            
            if (textLines[0]) {
                ctx.font = '900 60px Inter, sans-serif';
                ctx.fillStyle = 'white';
                ctx.shadowColor = "rgba(0,0,0,0.8)"; ctx.shadowBlur = 10;
                ctx.fillText(textLines[0].replace(/\*/g, '').toUpperCase(), 400, 120);
            }
            
            if (textLines[1]) {
                ctx.font = '800 50px Inter, sans-serif';
                ctx.fillStyle = '#facc15';
                ctx.shadowBlur = 0;
                ctx.fillText(textLines[1].replace(/\*/g, ''), 400, 650);
            }

            if (textLines[2]) {
                ctx.fillStyle = 'white';
                roundRect(ctx, 250, 700, 300, 70, 35);
                ctx.fill();
                ctx.fillStyle = '#4c1d95';
                ctx.font = 'bold 30px Inter, sans-serif';
                ctx.fillText(textLines[2].replace(/\*/g, '').toUpperCase(), 400, 745);
            }

            finalResult.src = canvas.toDataURL('image/png');
            downloadLink.href = canvas.toDataURL('image/png');
            downloadLink.classList.remove('hidden');
            downloadLink.classList.add('inline-flex');
        });

        function roundRect(ctx, x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.arcTo(x + w, y, x + w, y + h, r);
            ctx.arcTo(x + w, y + h, x, y + h, r);
            ctx.arcTo(x, y + h, x, y, r);
            ctx.arcTo(x, y, x + w, y, r);
            ctx.closePath();
        }
    </script>
</body>
</html>
